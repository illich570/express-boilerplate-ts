name: Deploy to Railway

on:
  workflow_run:
    workflows:
      - CI/CD Pipeline
    types:
      - completed

jobs:
  # STAGING: cuando el pipeline de CI/CD termina ok en main
  deploy-staging:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest

    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_SERVICE: ${{ secrets.RAILWAY_SERVICE }}

    steps:
      - name: Redeploy service on Railway (staging)
        run: railway redeploy --service="$RAILWAY_SERVICE" -y

  # PROD: cuando se etiqueta un release v* (usa la imagen ya construida en main)
  deploy-prod:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_SERVICE: ${{ secrets.RAILWAY_SERVICE_PROD }}
      IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/express-boilerplate-ts
      IMAGE_TAG: ${{ github.event.workflow_run.head_branch }}
      IMAGE_SHA: ${{ github.event.workflow_run.head_sha }}

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Usamos la imagen construida en el workflow de CI para este commit SHA
      - name: Pull image built from CI
        run: docker pull "$IMAGE_NAME:$IMAGE_SHA"

      - name: Tag image for production
        run: |
          docker tag "$IMAGE_NAME:$IMAGE_SHA" "$IMAGE_NAME:prod"
          docker tag "$IMAGE_NAME:$IMAGE_SHA" "$IMAGE_NAME:$IMAGE_TAG"

      - name: Push production tags
        run: |
          docker push "$IMAGE_NAME:prod"
          docker push "$IMAGE_NAME:$IMAGE_TAG"

      - name: Deploy to Railway (prod)
        uses: docker://ghcr.io/railwayapp/cli:latest
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE: ${{ secrets.RAILWAY_SERVICE_PROD }}
        with:
          entrypoint: /bin/sh
          args: -lc 'railway redeploy --service="$RAILWAY_SERVICE" -y'
